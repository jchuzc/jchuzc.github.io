<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>JNI In Multi-threading - JoeChu</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="JoeChu&#039;s Blog"><meta name="msapplication-TileImage" content="/img/expert.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="JoeChu&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Use JNI in the context of multi-threading."><meta property="og:type" content="blog"><meta property="og:title" content="JNI In Multi-threading"><meta property="og:url" content="http://chuzcjoe.github.io/misc/misc-jni-multi-threading/"><meta property="og:site_name" content="JoeChu"><meta property="og:description" content="Use JNI in the context of multi-threading."><meta property="og:locale" content="en_US"><meta property="og:image" content="http://chuzcjoe.github.io/misc/misc-jni-multi-threading/jvm.png"><meta property="og:image" content="http://chuzcjoe.github.io/misc/misc-jni-multi-threading/demo.png"><meta property="article:published_time" content="2024-12-24T03:56:40.000Z"><meta property="article:modified_time" content="2025-10-16T04:26:43.536Z"><meta property="article:author" content="Joe Chu"><meta property="article:tag" content="jni"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://chuzcjoe.github.io/misc/misc-jni-multi-threading/jvm.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://chuzcjoe.github.io/misc/misc-jni-multi-threading/"},"headline":"JNI In Multi-threading","image":["http://chuzcjoe.github.io/misc/misc-jni-multi-threading/jvm.png","http://chuzcjoe.github.io/misc/misc-jni-multi-threading/demo.png"],"datePublished":"2024-12-24T03:56:40.000Z","dateModified":"2025-10-16T04:26:43.536Z","author":{"@type":"Person","name":"Joe Chu"},"publisher":{"@type":"Organization","name":"JoeChu","logo":{"@type":"ImageObject","url":"http://chuzcjoe.github.io/img/expert.png"}},"description":"Use JNI in the context of multi-threading."}</script><link rel="canonical" href="http://chuzcjoe.github.io/misc/misc-jni-multi-threading/"><link rel="icon" href="/img/expert.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/expert.png" alt="JoeChu" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories/life">Life</a><a class="navbar-item" href="/categories/cpp">C/C++</a><a class="navbar-item" href="/categories/CGV">CG/CV</a><a class="navbar-item" href="/categories/interview">Interview</a><a class="navbar-item" href="/categories/misc">Misc</a><a class="navbar-item" href="/categories/tool">Tool</a><a class="navbar-item" href="/categories/wealth">Wealth</a><a class="navbar-item" href="/categories/resource">Resources</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/chuzcjoe"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-lightbulb" id="night-icon"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-10-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-24T03:56:40.000Z" title="12/23/2024, 7:56:40 PM">2024-12-23</time></span><span class="level-item"> Joe Chu </span><span class="level-item"><a class="link-muted" href="/categories/misc/">misc</a></span><span class="level-item">12 minutes read (About 1804 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">JNI In Multi-threading</h1><div class="content"><p>Use JNI in the context of multi-threading.</p>
<span id="more"></span>

<h1 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h1><p>Using JNI (Java Native Interface) in a multithreaded environment requires careful handling to ensure thread safety, proper lifecycle management of the JVM, and the native resources. JNI can be used in the context of Java multithreading, native multithreading or both. In each case, we need to carefully handle some key factors such as thread safety, JNI attchment and error handling.</p>
<p>Here is a high-level diagram illustrating the operation of JVM multithreading, highlighting the interaction between Java threads and native threads.</p>
<p align="center">
    <img src="jvm.png" title="A regular image" width="800px" height="700px">
</p>

<p>Key Differences Between <code>JNIEnv*</code> and <code>JavaVM*</code>:</p>
<ul>
<li><code>JNIEnv*</code> is thread-local and provides thread-specific access to JNI functions.</li>
<li><code>JavaVM*</code> is global to the JVM and allows operations across threads, such as attaching&#x2F;detaching threads.</li>
</ul>
<h1 id="2-Java-Multithreading"><a href="#2-Java-Multithreading" class="headerlink" title="2. Java Multithreading"></a>2. Java Multithreading</h1><p>When using JNI in the context of Java multithreading, here are some key considerations.</p>
<ol>
<li><p><strong>JNIEnv* env per thread</strong></p>
<ul>
<li><code>process(JNIEnv* env, jobject thiz)</code></li>
<li>Each Java thread calling into native code automatically gets its own JNIEnv*. You donâ€™t need to attach the thread to the JVM manually.</li>
<li>This pointer is thread-local and should not be shared between threads.</li>
<li>Avoid storing JNIEnv* in global variables or static storage.</li>
</ul>
</li>
<li><p><strong>Thread-Safety</strong></p>
<ul>
<li>Ensure the native code is thread-safe, especially if multiple Java threads interact with shared native resources.</li>
<li>Use synchronization mechanisms like <code>std::mutex</code> to protect shared data.</li>
</ul>
</li>
<li><p><strong>Global References</strong></p>
<ul>
<li>Use <code>NewGlobalRef</code> to create references for objects that need to be accessed by multiple threads or persist across JNI calls.</li>
<li>Always delete global references with <code>DeleteGlobalRef</code> when they are no longer needed.</li>
</ul>
</li>
<li><p><strong>Local References</strong></p>
<ul>
<li>JNI local references are valid only in the thread and scope where they are created. They must not be used across threads.</li>
<li>Use <code>DeleteLocalRef</code> to avoid memory leaks.</li>
</ul>
</li>
</ol>
<figure class="highlight java"><figcaption><span>JNIActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNIActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;jnimultithreading&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Native methods</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">nativeInit</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">nativeProcessData</span><span class="params">(<span class="type">int</span> threadId)</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">nativeCleanup</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Method to be called from native code</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onProgressUpdate</span><span class="params">(<span class="type">int</span> threadId, <span class="type">int</span> progress)</span> &#123;</span><br><span class="line">        runOnUiThread(() -&gt; &#123;</span><br><span class="line">            statusText.setText(<span class="string">&quot;Thread &quot;</span> + threadId + <span class="string">&quot;: &quot;</span> + progress + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NUM_THREADS</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isProcessing</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> TextView statusText;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        EdgeToEdge.enable(<span class="built_in">this</span>);</span><br><span class="line">        setContentView(R.layout.activity_jniactivity);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize native resources</span></span><br><span class="line">        nativeInit();</span><br><span class="line"></span><br><span class="line">        statusText = findViewById(R.id.status_text);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">btnStartThreads</span> <span class="operator">=</span> findViewById(R.id.btn_start_threads);</span><br><span class="line">        btnStartThreads.setOnClickListener(v -&gt; startProcessing());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isProcessing) <span class="keyword">return</span>;</span><br><span class="line">        isProcessing = <span class="literal">true</span>;</span><br><span class="line">        statusText.setText(<span class="string">&quot;Processing started...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create and start multiple Java threads</span></span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> <span class="title class_">Thread</span>[NUM_THREADS];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; NUM_THREADS; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadId</span> <span class="operator">=</span> i;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                nativeProcessData(threadId);</span><br><span class="line">            &#125;);</span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start a monitoring thread to wait for all threads to complete</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">                    thread.join();</span><br><span class="line">                &#125;</span><br><span class="line">                runOnUiThread(() -&gt; &#123;</span><br><span class="line">                    statusText.setText(<span class="string">&quot;Processing completed!&quot;</span>);</span><br><span class="line">                    isProcessing = <span class="literal">false</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        <span class="comment">// Cleanup native resources</span></span><br><span class="line">        nativeCleanup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>jnimultithreading.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG <span class="string">&quot;JNIMultiThreading&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Mutex for thread synchronization</span></span><br><span class="line">std::mutex g_mutex;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Global references</span></span><br><span class="line">jclass g_activity_class = <span class="literal">nullptr</span>;  <span class="comment">// Global reference to the Activity class</span></span><br><span class="line">jmethodID g_progress_method = <span class="literal">nullptr</span>;  <span class="comment">// Method ID (not a global reference)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span> </span>&#123;</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span>**)&amp;env, JNI_VERSION_1_6) != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the Activity class</span></span><br><span class="line">    jclass localClass = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/jnimultithreading/JNIActivity&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (localClass == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create global reference to the class</span></span><br><span class="line">    g_activity_class = (jclass)env-&gt;<span class="built_in">NewGlobalRef</span>(localClass);</span><br><span class="line">    env-&gt;<span class="built_in">DeleteLocalRef</span>(localClass);  <span class="comment">// Delete the local reference</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cache the method ID</span></span><br><span class="line">    g_progress_method = env-&gt;<span class="built_in">GetMethodID</span>(g_activity_class, <span class="string">&quot;onProgressUpdate&quot;</span>, <span class="string">&quot;(II)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_jnimultithreading_JNIActivity_nativeProcessData</span><span class="params">(JNIEnv *env, jobject thiz, jint thread_id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Simulate work with progress updates</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; i += <span class="number">20</span>) &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(g_mutex)</span></span>;</span><br><span class="line">            <span class="built_in">LOGI</span>(<span class="string">&quot;Thread %d progress: %d%%&quot;</span>, thread_id, i);</span><br><span class="line">            env-&gt;<span class="built_in">CallVoidMethod</span>(thiz, g_progress_method, thread_id, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">500000</span>); <span class="comment">// Sleep for 500ms</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_jnimultithreading_JNIActivity_nativeInit</span><span class="params">(JNIEnv *env, jobject thiz)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;Native resources initialized&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_jnimultithreading_JNIActivity_nativeCleanup</span><span class="params">(JNIEnv *env, jobject thiz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_activity_class != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        env-&gt;<span class="built_in">DeleteGlobalRef</span>(g_activity_class);</span><br><span class="line">        g_activity_class = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    g_progress_method = <span class="literal">nullptr</span>;  <span class="comment">// Just set to null, no need to delete</span></span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;Native resources cleaned up&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">JNI_OnUnload</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span> </span>&#123;</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span>**)&amp;env, JNI_VERSION_1_6) != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up global references</span></span><br><span class="line">    <span class="keyword">if</span> (g_activity_class != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        env-&gt;<span class="built_in">DeleteGlobalRef</span>(g_activity_class);</span><br><span class="line">        g_activity_class = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-Native-Multithreading"><a href="#3-Native-Multithreading" class="headerlink" title="3. Native Multithreading"></a>3. Native Multithreading</h1><p>If multithreading happens in native code (rather than in Java), there are notable differences in how threads are managed, synchronized, and interact with the Java Virtual Machine (JVM). The most significant difference is:</p>
<p><strong>Thread Lifecycle</strong><br>    - Created and managed outside of the JVM, typically using threading APIs like <code>std::thread</code> (C++), POSIX threads, or platform-specific APIs.<br>    - Do not have an automatic relationship with the JVM; they must explicitly attach to the JVM using <code>AttachCurrentThread</code> if they need to interact with Java objects.<br>    - After their work is done, they must detach using <code>DetachCurrentThread</code> to avoid memory leaks.</p>
<p><strong>JavaVM</strong>*<br>To attach&#x2F;detach a native thread from JVM, we need the <code>JavaVM*</code> pointer. The <code>JavaVM*</code> pointer in the JNI represents the JVM instance running the Java code. Unlike the <code>JNIEnv*</code>, which is thread-local and specific to a single thread, the <code>JavaVM*</code> is global and shared across all threads in the JVM. It provides a way for native code to interact with the JVM at a higher level, enabling operations that span multiple threads.</p>
<p>As we mentioned in the diagram in section 1, for threads created in native code:</p>
<ul>
<li>The <code>JavaVM*</code> is commonly used for attaching and detaching native threads to&#x2F;from the JVM, ensuring they can use JNI functions.</li>
<li>Native threads must attach themselves to the JVM using the <code>JavaVM*</code> before accessing JNI.</li>
</ul>
<p><strong>Demo</strong><br>To illustrate how JNI operates in the presence of native threads, we will create a more complex example.</p>
<p align="center">
    <img src="demo.png" title="A regular image" width="800px" height="700px">
</p>

<figure class="highlight java"><figcaption><span>MainActivity.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jnimultinativethread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.os.Looper;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TextView outputText;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringBuilder</span> <span class="variable">logBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">private</span> NativeWorker nativeWorker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Handler</span> <span class="variable">mainHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ThreadProgressCallback</span> <span class="variable">callback</span> <span class="operator">=</span> value -&gt; &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nativeThreadId</span> <span class="operator">=</span> nativeWorker.getNativeThreadId();</span><br><span class="line">        Log.i(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;JC, Callback running on thread: &quot;</span> + nativeThreadId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process on native thread</span></span><br><span class="line">        logBuilder.append(<span class="string">&quot;Java received: &quot;</span>).append(value).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> nativeWorker.processValue(value);</span><br><span class="line">        logBuilder.append(<span class="string">&quot;Native processed and returned: &quot;</span>).append(result).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Test the thread-registered method</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">threadResult</span> <span class="operator">=</span> nativeWorker.threadRegisteredMethod(value);</span><br><span class="line">        logBuilder.append(<span class="string">&quot;Thread-registered method returned: &quot;</span>).append(threadResult).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Only use UI thread for updating TextView</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> logBuilder.toString();</span><br><span class="line">        mainHandler.post(() -&gt; outputText.setText(output));</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        outputText = findViewById(R.id.outputText);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">startButton</span> <span class="operator">=</span> findViewById(R.id.startButton);</span><br><span class="line">        </span><br><span class="line">        nativeWorker = <span class="keyword">new</span> <span class="title class_">NativeWorker</span>(callback);</span><br><span class="line"></span><br><span class="line">        startButton.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            logBuilder.setLength(<span class="number">0</span>);</span><br><span class="line">            outputText.setText(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            logBuilder.append(<span class="string">&quot;Starting async work...\n&quot;</span>);</span><br><span class="line">            outputText.setText(logBuilder.toString());</span><br><span class="line">            </span><br><span class="line">            nativeWorker.startAsyncWork();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><figcaption><span>native-lib.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG <span class="string">&quot;NativeLib&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Global reference to Java VM and callback</span></span><br><span class="line"><span class="type">static</span> JavaVM* g_vm = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> jobject g_callback_object = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> jmethodID g_callback_method = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> jclass g_native_worker_class = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// New method that will be registered from the native thread</span></span><br><span class="line"><span class="function">jint <span class="title">threadRegisteredMethod</span><span class="params">(JNIEnv* env, jobject thiz, jint value)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;JC, threadRegisteredMethod called on thread: %ld&quot;</span>, std::this_thread::<span class="built_in">get_id</span>());</span><br><span class="line">    <span class="keyword">return</span> value * <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Worker thread function that will call back to Java</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">nativeThread</span><span class="params">(<span class="type">int</span> initialValue)</span> </span>&#123;</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="type">bool</span> needsDetach = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attach thread to JVM if needed</span></span><br><span class="line">    <span class="type">int</span> getEnvResult = g_vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span>**)&amp;env, JNI_VERSION_1_6);</span><br><span class="line">    <span class="keyword">if</span> (getEnvResult == JNI_EDETACHED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_vm-&gt;<span class="built_in">AttachCurrentThread</span>(&amp;env, <span class="literal">nullptr</span>) == JNI_OK) &#123;</span><br><span class="line">            needsDetach = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">LOGI</span>(<span class="string">&quot;Failed to attach thread to JVM&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;JC, Native thread started with ID: %ld&quot;</span>, std::this_thread::<span class="built_in">get_id</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register the new native method using the cached class reference</span></span><br><span class="line">    <span class="keyword">if</span> (g_native_worker_class != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        JNINativeMethod threadMethod[] = &#123;</span><br><span class="line">            &#123;<span class="string">&quot;threadRegisteredMethod&quot;</span>, <span class="string">&quot;(I)I&quot;</span>, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(threadRegisteredMethod)&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (env-&gt;<span class="built_in">RegisterNatives</span>(g_native_worker_class, threadMethod, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">LOGI</span>(<span class="string">&quot;Failed to register thread method&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">LOGI</span>(<span class="string">&quot;Successfully registered thread method&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Simulate some work</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call back to Java with the value</span></span><br><span class="line">    env-&gt;<span class="built_in">CallVoidMethod</span>(g_callback_object, g_callback_method, initialValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Detach thread if we attached it</span></span><br><span class="line">    <span class="keyword">if</span> (needsDetach) &#123;</span><br><span class="line">        g_vm-&gt;<span class="built_in">DetachCurrentThread</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">startAsyncWork</span><span class="params">(JNIEnv* env, jobject thiz)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Get the callback field from NativeWorker</span></span><br><span class="line">    jfieldID callbackField = env-&gt;<span class="built_in">GetFieldID</span>(env-&gt;<span class="built_in">GetObjectClass</span>(thiz),</span><br><span class="line">                                           <span class="string">&quot;callback&quot;</span>,</span><br><span class="line">                                           <span class="string">&quot;Lcom/example/jnimultinativethread/ThreadProgressCallback;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get callback object and method</span></span><br><span class="line">    jobject localCallback = env-&gt;<span class="built_in">GetObjectField</span>(thiz, callbackField);</span><br><span class="line">    jclass callbackClass = env-&gt;<span class="built_in">GetObjectClass</span>(localCallback);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create global reference to callback object</span></span><br><span class="line">    <span class="keyword">if</span> (g_callback_object != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        env-&gt;<span class="built_in">DeleteGlobalRef</span>(g_callback_object);</span><br><span class="line">    &#125;</span><br><span class="line">    g_callback_object = env-&gt;<span class="built_in">NewGlobalRef</span>(localCallback);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get callback method ID</span></span><br><span class="line">    g_callback_method = env-&gt;<span class="built_in">GetMethodID</span>(callbackClass, <span class="string">&quot;onNativeCallback&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start native thread with initial value</span></span><br><span class="line">    <span class="function">std::thread <span class="title">worker</span><span class="params">(nativeThread, <span class="number">42</span>)</span></span>;</span><br><span class="line">    worker.<span class="built_in">detach</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">processValue</span><span class="params">(JNIEnv* env, jobject thiz, jint value)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;JC, processValue called on thread: %ld&quot;</span>, std::this_thread::<span class="built_in">get_id</span>());</span><br><span class="line">    <span class="keyword">return</span> value * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Native method mapping table for initial registration</span></span><br><span class="line"><span class="type">static</span> JNINativeMethod methods[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;startAsyncWork&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(startAsyncWork)&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;processValue&quot;</span>, <span class="string">&quot;(I)I&quot;</span>, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(processValue)&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jint JNICALL</span></span><br><span class="line"><span class="function"><span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span> </span>&#123;</span><br><span class="line">    g_vm = vm;</span><br><span class="line"></span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;<span class="built_in">GetEnv</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;env), JNI_VERSION_1_6) != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find and cache the NativeWorker class</span></span><br><span class="line">    jclass localClass = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/example/jnimultinativethread/NativeWorker&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (localClass == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    g_native_worker_class = (jclass)env-&gt;<span class="built_in">NewGlobalRef</span>(localClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register initial native methods</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">RegisterNatives</span>(g_native_worker_class, methods, <span class="built_in">sizeof</span>(methods)/<span class="built_in">sizeof</span>(methods[<span class="number">0</span>])) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jlong JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_jnimultinativethread_NativeWorker_getNativeThreadId</span><span class="params">(JNIEnv* env, jobject thiz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (jlong)<span class="built_in">pthread_self</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">JNI_OnUnload</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span> </span>&#123;</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;<span class="built_in">GetEnv</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;env), JNI_VERSION_1_6) != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up global references</span></span><br><span class="line">    <span class="keyword">if</span> (g_callback_object != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        env-&gt;<span class="built_in">DeleteGlobalRef</span>(g_callback_object);</span><br><span class="line">        g_callback_object = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (g_native_worker_class != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        env-&gt;<span class="built_in">DeleteGlobalRef</span>(g_native_worker_class);</span><br><span class="line">        g_native_worker_class = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is worth noting that <code>Thread.getId()</code> in Java and <code>std::this_thread::get_id()</code> in C++ use different numbering systems for thread IDs. To make them match and be more comparable, we return <code>pthread_self()</code> from the native code and let Java obtained the native thread id.</p>
<p>The log information confirms the accuracy of our illustration above.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">JC, Native thread started with ID: 493381438640</span><br><span class="line">JC, Callback running on thread: 493381438640</span><br><span class="line">JC, processValue called on thread: 493381438640</span><br><span class="line">JC, threadRegisteredMethod called on thread: 493381438640</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>JNI In Multi-threading</p><p><a href="http://chuzcjoe.github.io/misc/misc-jni-multi-threading/">http://chuzcjoe.github.io/misc/misc-jni-multi-threading/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Joe Chu</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-12-23</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-10-15</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/jni/">jni</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://chuzcjoe.github.io/" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/" alt="Alipay"></span></a><a class="button donate" data-type="paypal" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="chuzcjoe@gmail.com"><input type="hidden" name="currency_code" value="USD"></form><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="/img/wechat.jpg" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/life/life-christmas-eve/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Christmas Eve</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/life/life-monterey-trip/"><span class="level-item">Holiday Trip - Monterey</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'http://chuzcjoe.github.io/misc/misc-jni-multi-threading/';
            this.page.identifier = 'misc/misc-jni-multi-threading/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'chuzcjoe-github-io' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/me.jpeg" alt="Joe Chu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Joe Chu</p><p class="is-size-6 is-block">I like to keep knowledge and memories visible and readable.</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Fremont, CA</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">247</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">187</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/chuzcjoe" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/chuzcjoe"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://www.linkedin.com/in/joe-chu-1784b3179/"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Scholar" href="https://scholar.google.com/citations?user=DCwJ1qcAAAAJ&amp;hl=en"><i class="fab fa-google"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-Introduction"><span class="level-left"><span class="level-item">1</span><span class="level-item">1. Introduction</span></span></a></li><li><a class="level is-mobile" href="#2-Java-Multithreading"><span class="level-left"><span class="level-item">2</span><span class="level-item">2. Java Multithreading</span></span></a></li><li><a class="level is-mobile" href="#3-Native-Multithreading"><span class="level-left"><span class="level-item">3</span><span class="level-item">3. Native Multithreading</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/expert.png" alt="JoeChu" height="28"></a><p class="is-size-7"><span>&copy; 2025 Joe Chu</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">uv <span id="busuanzi_value_site_uv">0</span></span><br><span id="busuanzi_container_site_pv">pv <span id="busuanzi_value_site_pv">0</span></span></p><p class="is-size-7">Â© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>